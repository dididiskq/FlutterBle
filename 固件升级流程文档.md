# 固件升级详细流程文档

## 目录
1. [概述](#概述)
2. [前置准备](#前置准备)
3. [升级流程详解](#升级流程详解)
4. [命令协议详解](#命令协议详解)
5. [错误处理](#错误处理)
6. [BLE通信机制](#ble通信机制)

---

## 概述

### 升级流程概述
固件升级（OTA - Over The Air）是通过蓝牙低功耗（BLE）通信，将新的固件镜像传输到设备并激活的过程。整个升级过程采用命令-响应模式，确保每个步骤都正确执行后再进行下一步。

### 升级状态枚举
```dart
enum UpgradeStatus {
  idle,           // 空闲状态
  checkingUpdate, // 检查更新
  downloading,    // 下载中
  upgrading,      // 升级中
  completed,      // 完成
  failed,         // 失败
}
```

### OTA命令定义
| 命令码 | 命令名称 | 说明 |
|--------|----------|------|
| 0x01 | OTA_CMD_CONN_PARAM_UPDATE | 连接参数更新 |
| 0x02 | OTA_CMD_MTU_UPDATE | MTU更新 |
| 0x03 | OTA_CMD_VERSION | 版本请求 |
| 0x04 | OTA_CMD_CREATE_OTA_SETTING | 创建设置传输 |
| 0x05 | OTA_CMD_CREATE_OTA_IMAGE | 创建镜像传输 |
| 0x06 | OTA_CMD_VALIDATE_OTA_IMAGE | 验证镜像 |
| 0x07 | OTA_CMD_ACTIVATE_OTA_IMAGE | 激活镜像 |
| 0x08 | OTA_CMD_JUMP_IMAGE_UPDATE | 跳转至镜像更新 |

### 错误代码定义
| 错误代码 | 说明 |
|----------|------|
| 0x00 | 成功 |
| 0x01 | 参数无效 |
| 0x02 | CRC校验失败 |
| 0x03 | 签名失败 |

---

## 前置准备

### 1. 设备连接检查
在开始升级前，必须确保设备已成功连接：

```dart
if (_bleController.connectedDevice == null) {
  throw Exception('设备未连接，请先连接设备后再进行OTA升级');
}
```

### 2. 切换到OTA模式
OTA升级使用专用的服务和特征UUID，与正常业务功能分离：

**正常业务UUID：**
- 服务UUID: `00002760-08C2-11E1-9073-0E8AC72E1001`
- 写入UUID: `00002760-08C2-11E1-9073-0E8AC72E0001`
- 通知UUID: `00002760-08C2-11E1-9073-0E8AC72E0002`

**OTA升级UUID：**
- 服务UUID: `11110001-1111-1111-1111-111111111111`
- 写入UUID: `11110002-1111-1111-1111-111111111111`
- 通知UUID: `11110003-1111-1111-1111-111111111111`

切换步骤：
1. 取消当前通知订阅
2. 切换UUID到OTA专用UUID
3. 重新发现服务和特征
4. 启用通知

```dart
await _bleController.enableOtaMode();
```

---

## 升级流程详解

### 整体流程图
```
开始
  ↓
检查设备连接
  ↓
切换到OTA模式
  ↓
连接参数更新 (进度: 10%)
  ↓
MTU更新 (进度: 20%)
  ↓
版本请求 (进度: 30%)
  ↓
判断OTA选择
  ├─ otaSelection == 4 → 跳转至镜像更新程序
  └─ 其他 → 完整升级流程
       ↓
     创建设置传输 (进度: 40%)
       ↓
     发送设置数据 (进度: 50%)
       ↓
     创建镜像传输 (进度: 60%)
       ↓
     发送镜像数据 (进度: 90%)
       ↓
     验证新镜像 (进度: 95%)
       ↓
     激活新镜像 (进度: 100%)
       ↓
切换回正常模式
  ↓
完成
```

### 步骤1：连接参数更新

**目的：** 优化BLE连接参数以提高数据传输效率

**参数配置：**
- intervalMin: 15 (最小连接间隔)
- intervalMax: 50 (最大连接间隔)
- latency: 0 (从机延迟)
- timeout: 500 (连接超时，单位：10ms，即5秒)

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x01 (命令码)
1-2      | intervalMin (大端序)
3-4      | intervalMax (大端序)
5-6      | latency (大端序)
7-8      | timeout (大端序)
```

**示例数据：**
```
[0x01, 0x00, 0x0F, 0x00, 0x32, 0x00, 0x00, 0x01, 0xF4]
```

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x01 (命令码)
1        | 错误代码 (0x00=成功)
```

**执行流程：**
1. 订阅BLE通知流
2. 等待200ms确保订阅生效
3. 构建命令数据包
4. 写入命令到BLE特征（不带响应）
5. 等待设备响应（超时10秒）
6. 验证响应命令码和错误代码
7. 取消订阅

**错误处理：**
- 超时：10秒未收到响应
- 错误代码非0：参数更新失败

---

### 步骤2：MTU更新

**目的：** 增加BLE数据传输单元大小，提高传输效率

**参数配置：**
- MTU值: 200字节

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x02 (命令码)
1-2      | MTU值 (大端序)
```

**示例数据：**
```
[0x02, 0x00, 0xC8]
```

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x02 (命令码)
1        | 错误代码 (0x00=成功)
```

**执行流程：**
1. 订阅BLE通知流
2. 构建命令数据包
3. 写入命令到BLE特征（不带响应）
4. 等待设备响应（超时10秒）
5. 验证响应命令码和错误代码
6. 取消订阅

**错误处理：**
- 超时：10秒未收到响应
- 错误代码非0：MTU更新失败

---

### 步骤3：版本请求

**目的：** 获取设备当前固件版本信息，确定升级目标

**请求参数：**
- app1BinSize: APP1.bin文件大小
- app2BinSize: APP2.bin文件大小
- imageUpdateBinSize: ImageUpdate.bin文件大小
- imageUpdateVersion: ImageUpdate版本号

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x03 (命令码)
1-4      | app1BinSize (大端序)
5-8      | app2BinSize (大端序)
9-12     | imageUpdateBinSize (大端序)
13-16    | imageUpdateVersion (大端序)
```

**示例数据：**
```
[0x03, 0x00, 0x00, 0x00, 0x00, 
 0x00, 0x00, 0x00, 0x00, 
 0x00, 0x10, 0x00, 0x00, 
 0x01, 0x00, 0x00, 0x00]
```

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x03 (命令码)
1-4      | APP1版本号 (大端序)
5-8      | APP2版本号 (大端序)
9-12     | ImageUpdate版本号 (大端序)
13       | OTA选择 (1=APP1, 2=APP2, 3=ImageUpdate, 4=跳转)
```

**OTA选择说明：**
- 1: 升级APP1.bin
- 2: 升级APP2.bin
- 3: 升级ImageUpdate.bin
- 4: 跳转至镜像更新程序（由镜像更新程序处理后续流程）

**执行流程：**
1. 订阅BLE通知流
2. 构建命令数据包
3. 写入命令到BLE特征（不带响应）
4. 等待设备响应（超时10秒）
5. 解析响应数据：
   - 提取APP1、APP2、ImageUpdate版本号
   - 提取OTA选择值
6. 根据OTA选择设置固件文件路径和大小
7. 验证OTA选择是否有效（1-4）
8. 取消订阅

**错误处理：**
- 超时：10秒未收到响应
- OTA选择无效：不在1-4范围内

---

### 步骤4：创建设置传输（otaSelection != 4）

**目的：** 通知设备准备接收DFU设置数据

**参数配置：**
- dfuSettingSize: DFU设置数据大小

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x04 (命令码)
1-4      | dfuSettingSize (大端序)
```

**示例数据：**
```
[0x04, 0x00, 0x00, 0x00, 0x00]
```

**执行流程：**
1. 构建命令数据包
2. 写入命令到BLE特征（带响应）
3. 等待写入完成

**错误处理：**
- 写入失败：BLE通信错误

---

### 步骤5：发送设置数据

**目的：** 传输DFU设置数据到设备

**数据格式：**
- 直接传输设置数据的字节流

**执行流程：**
1. 订阅BLE通知流
2. 构建设置数据包
3. 写入数据到BLE特征（不带响应，使用拆分数据包）
4. 等待设备响应（超时10秒）
5. 验证响应命令码和错误代码
6. 取消订阅

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x04 (命令码)
1        | 错误代码 (0x00=成功)
```

**错误处理：**
- 超时：10秒未收到响应
- 错误代码非0：数据传输失败

---

### 步骤6：创建镜像传输

**目的：** 通知设备准备接收固件镜像数据

**参数配置：**
- imageOffset: 镜像偏移量
- imageSize: 镜像大小
- imageCrc: 镜像CRC校验值

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x05 (命令码)
1-4      | imageOffset (大端序)
5-8      | imageSize (大端序)
9-12     | imageCrc (大端序)
```

**示例数据：**
```
[0x05, 0x00, 0x00, 0x00, 0x00, 
 0x00, 0x10, 0x00, 0x00, 
 0x12, 0x34, 0x56, 0x78]
```

**执行流程：**
1. 构建命令数据包
2. 写入命令到BLE特征（带响应）
3. 等待写入完成

**错误处理：**
- 写入失败：BLE通信错误

---

### 步骤7：发送镜像数据

**目的：** 传输固件镜像数据到设备

**数据格式：**
- 直接传输镜像数据的字节流

**执行流程：**
1. 订阅BLE通知流
2. 分块读取镜像数据
3. 逐块写入到BLE特征（不带响应）
4. 更新传输进度
5. 等待设备响应（超时10秒）
6. 验证响应命令码和错误代码
7. 取消订阅

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x05 (命令码)
1        | 错误代码 (0x00=成功)
```

**错误处理：**
- 超时：10秒未收到响应
- 错误代码非0：数据传输失败

---

### 步骤8：验证新镜像

**目的：** 验证传输的镜像数据完整性

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x06 (命令码)
```

**示例数据：**
```
[0x06]
```

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x06 (命令码)
1        | 错误代码 (0x00=成功)
```

**执行流程：**
1. 订阅BLE通知流
2. 构建验证命令数据包
3. 更新进度为90%
4. 写入命令到BLE特征（带响应）
5. 等待设备响应（超时10秒）
6. 验证响应命令码和错误代码
7. 取消订阅

**错误处理：**
- 超时：10秒未收到响应
- 错误代码非0：验证失败（可能是CRC校验失败或签名失败）

---

### 步骤9：激活新镜像

**目的：** 激活新传输的固件镜像

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x07 (命令码)
```

**示例数据：**
```
[0x07]
```

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x07 (命令码)
1        | 错误代码 (0x00=成功)
```

**执行流程：**
1. 订阅BLE通知流
2. 构建激活命令数据包
3. 更新状态为90%进度
4. 写入命令到BLE特征（不带响应）
5. 等待设备响应（超时30秒，激活可能需要较长时间）
6. 验证响应命令码和错误代码
7. 取消订阅

**错误处理：**
- 超时：30秒未收到响应
- 错误代码非0：激活失败

---

### 步骤10：跳转至镜像更新（otaSelection == 4）

**目的：** 跳转到设备内部的镜像更新程序

**命令格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x08 (命令码)
```

**示例数据：**
```
[0x08]
```

**响应格式：**
```
字节位置 | 内容
---------|------------------
0        | 0x08 (命令码)
1        | 错误代码 (0x00=成功)
```

**执行流程：**
1. 订阅BLE通知流
2. 构建跳转命令数据包
3. 更新状态为35%进度
4. 写入命令到BLE特征（不带响应）
5. 等待设备响应（超时5秒）
6. 验证响应命令码和错误代码
7. 取消订阅
8. 后续流程由镜像更新程序处理

**错误处理：**
- 超时：5秒未收到响应
- 错误代码非0：跳转失败

---

### 步骤11：切换回正常模式

**目的：** 升级完成后，恢复正常的业务功能UUID

**执行流程：**
1. 取消OTA通知订阅
2. 切换UUID回正常业务UUID
3. 重新发现服务和特征
4. 启用通知

```dart
await _bleController.disableOtaMode();
```

---

## 命令协议详解

### 通用命令结构

所有OTA命令遵循以下结构：

**请求格式：**
```
[命令码] [参数1] [参数2] ... [参数N]
```

**响应格式：**
```
[命令码] [错误代码] [响应数据...]
```

### 数据编码规则

1. **多字节数据：** 采用大端序（Big-Endian）编码
   - 高位字节在前，低位字节在后
   - 示例：值0x12345678 编码为 [0x12, 0x34, 0x56, 0x78]

2. **字节数组：** 直接传输，无需额外编码

3. **错误代码：** 单字节，0表示成功，非0表示失败

### 命令超时设置

| 命令 | 超时时间 | 说明 |
|------|----------|------|
| 连接参数更新 | 10秒 | 需要设备重新配置连接参数 |
| MTU更新 | 10秒 | 需要协商新的MTU值 |
| 版本请求 | 10秒 | 需要读取多个版本信息 |
| 创建设置传输 | 即时 | 仅发送命令，等待写入完成 |
| 发送设置数据 | 10秒 | 数据传输需要时间 |
| 创建镜像传输 | 即时 | 仅发送命令，等待写入完成 |
| 发送镜像数据 | 10秒 | 数据传输需要时间 |
| 验证新镜像 | 10秒 | 需要进行CRC和签名验证 |
| 激活新镜像 | 30秒 | 激活可能需要较长时间 |
| 跳转至镜像更新 | 5秒 | 快速跳转操作 |

---

## 错误处理

### 错误分类

1. **连接错误**
   - 设备未连接
   - 服务发现失败
   - 特征值未找到

2. **通信错误**
   - 写入失败
   - 响应超时
   - 数据校验失败

3. **协议错误**
   - 无效命令码
   - 参数无效
   - CRC校验失败
   - 签名验证失败

4. **设备错误**
   - 存储空间不足
   - 版本不兼容
   - 升级失败

### 错误处理流程

```dart
try {
  // 执行升级流程
  await startUpgrade();
} catch (error) {
  // 升级失败，切换回正常模式
  await _bleController.disableOtaMode();
  
  // 发布失败状态
  _upgradeStatusController.add(UpgradeStatusData(
    UpgradeStatus.failed,
    0,
    '升级失败: $error'
  ));
  
  // 重新抛出异常
  rethrow;
}
```

### 错误恢复策略

1. **超时错误：**
   - 检查设备连接状态
   - 重新发送命令
   - 如仍失败，终止升级

2. **CRC校验错误：**
   - 重新计算CRC
   - 重新传输数据
   - 如仍失败，检查固件文件

3. **签名验证错误：**
   - 检查固件签名
   - 确认固件来源
   - 终止升级，提示用户

4. **参数无效错误：**
   - 检查命令参数
   - 修正参数后重试
   - 如仍失败，终止升级

---

## BLE通信机制

### 通知订阅机制

每个OTA命令执行前都需要订阅BLE通知流：

```dart
final StreamSubscription<List<int>> subscription = 
  _bleController.notificationStream.listen((data) {
    // 处理响应数据
  });
```

**订阅时机：**
- 在发送命令前订阅
- 等待200ms确保订阅生效
- 收到响应或超时后取消订阅

**响应验证：**
1. 检查响应数据长度
2. 验证命令码是否匹配
3. 检查错误代码
4. 解析响应数据

### 数据写入方式

根据命令类型选择不同的写入方式：

1. **不带响应写入（writeWithoutResponse）：**
   - 用于发送OTA命令
   - 速度更快
   - 适用于不需要确认的场景

2. **带响应写入（writeWithResponse）：**
   - 用于创建传输等关键命令
   - 确保命令已接收
   - 适用于需要确认的场景

### 数据包拆分

对于大数据传输（如镜像数据），需要拆分成多个小包：

- 每包大小受MTU限制
- 逐包发送，等待设备处理
- 更新传输进度

### 状态通知

升级过程中通过Stream实时通知状态：

```dart
_upgradeStatusController.add(UpgradeStatusData(
  UpgradeStatus.checkingUpdate,
  10,
  '连接参数更新完成'
));
```

**状态信息：**
- 当前状态枚举
- 进度百分比（0-100）
- 状态描述信息

---

## 附录

### A. 完整命令列表

| 命令码 | 命令名称 | 请求长度 | 响应长度 | 超时时间 |
|--------|----------|----------|----------|----------|
| 0x01 | 连接参数更新 | 9字节 | 2字节 | 10秒 |
| 0x02 | MTU更新 | 3字节 | 2字节 | 10秒 |
| 0x03 | 版本请求 | 17字节 | 14字节 | 10秒 |
| 0x04 | 创建设置传输 | 5字节 | - | 即时 |
| 0x04 | 发送设置数据 | 可变 | 2字节 | 10秒 |
| 0x05 | 创建镜像传输 | 13字节 | - | 即时 |
| 0x05 | 发送镜像数据 | 可变 | 2字节 | 10秒 |
| 0x06 | 验证新镜像 | 1字节 | 2字节 | 10秒 |
| 0x07 | 激活新镜像 | 1字节 | 2字节 | 30秒 |
| 0x08 | 跳转至镜像更新 | 1字节 | 2字节 | 5秒 |

### B. UUID配置

**正常业务UUID：**
```
服务UUID: 00002760-08C2-11E1-9073-0E8AC72E1001
写入UUID: 00002760-08C2-11E1-9073-0E8AC72E0001
通知UUID: 00002760-08C2-11E1-9073-0E8AC72E0002
```

**OTA升级UUID：**
```
服务UUID: 11110001-1111-1111-1111-111111111111
写入UUID: 11110002-1111-1111-1111-111111111111
通知UUID: 11110003-1111-1111-1111-111111111111
```

### C. 进度映射

| 阶段 | 进度 | 状态 |
|------|------|------|
| 开始升级 | 0% | checkingUpdate |
| 连接参数更新完成 | 10% | checkingUpdate |
| MTU更新完成 | 20% | checkingUpdate |
| 版本请求完成 | 30% | checkingUpdate |
| 创建设置传输完成 | 40% | checkingUpdate |
| 发送设置数据完成 | 50% | downloading |
| 创建镜像传输完成 | 60% | downloading |
| 发送镜像数据完成 | 90% | upgrading |
| 验证新镜像完成 | 95% | upgrading |
| 激活新镜像完成 | 100% | completed |

### D. 参考实现

本实现参考了Java版本的BleOTA.java，确保协议一致性和兼容性。

**关键参考点：**
- 连接参数配置
- 命令格式定义
- 响应处理逻辑
- 超时时间设置
- 错误处理机制

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-01-05 | 初始版本，完整升级流程文档 |

---

## 联系方式

如有问题或建议，请联系开发团队。
