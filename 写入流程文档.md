# BMS电池串数写入流程文档

## 目录
- [写入到响应完整流程图](#写入到响应完整流程图)
- [关键时序图](#关键时序图)
- [关键数据流](#关键数据流)
- [超时处理](#超时处理)

---

## 写入到响应完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                │
│                    (quick_settings_page.dart)                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 用户在输入框中输入电池串数                                     │
│     例如：输入 "16"                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 用户点击"设置"按钮                                            │
│     触发 _writeBatterySeriesCount() 方法                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 输入验证                                                     │
│     ├─ 检查输入是否为空                                          │
│     ├─ 检查是否为有效数字                                         │
│     └─ 检查设备是否已连接                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 更新UI状态                                                    │
│     显示 "正在写入..." (蓝色) + 加载动画                         │
│     禁用设置按钮                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    业务逻辑层                                    │
│                  (battery_data_manager.dart)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 调用 writeBatterySeriesCount(count)                         │
│     例如：writeBatterySeriesCount(16)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 调用 writeParameters(0x200, [16])                           │
│     ├─ 生成请求ID (requestId)                                    │
│     ├─ 创建 ModbusRequest.writeParameters 对象                   │
│     │   ├─ id: requestId                                        │
│     │   ├─ slaveId: 0x16                                        │
│     │   ├─ startAddress: 0x200                                  │
│     │   └─ values: [16]                                         │
│     └─ 调用 _sendRequest(request)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. _sendRequest 方法                                            │
│     ├─ 检查设备连接状态                                          │
│     ├─ 构建Modbus写入命令                                        │
│     │   调用 _protocol.buildWriteCommand()                       │
│     │   ├─ Slave ID: 0x16                                       │
│     │   ├─ Function Code: 0x10 (写入多个保持寄存器)             │
│     │   ├─ Start Address: 0x200                                 │
│     │   ├─ Quantity: 1                                          │
│     │   ├─ Byte Count: 2                                        │
│     │   ├─ Data: 0x0010 (16)                                    │
│     │   └─ CRC16校验码                                           │
│     │   最终命令: 16 10 02 00 01 00 10 CRC_L CRC_H              │
│     ├─ 更新请求状态为 sent                                       │
│     ├─ 将请求加入待处理列表 _pendingRequests                    │
│     └─ 通过BLE发送命令                                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    通信层                                        │
│                    (ble_controller.dart)                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. BLE发送数据到BMS设备                                         │
│     writeData(command)                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BMS设备                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. BMS设备处理写入请求                                          │
│     ├─ 验证从站地址                                               │
│     ├─ 验证功能码                                                 │
│     ├─ 验证寄存器地址                                             │
│     ├─ 写入数据到0x200寄存器                                      │
│     └─ 返回写入应答                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  10. BMS设备返回写入应答                                          │
│      格式: SlaveID FunctionCode StartAddr_L StartAddr_H         │
│            Quantity_L Quantity_H CRC_L CRC_H                     │
│      例如: 16 10 00 02 00 01 CRC_L CRC_H                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  11. BLE接收数据                                                 │
│      onDataReceived(data)                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  12. 调用 handleResponse(data)                                   │
│      ├─ 打印接收到的响应                                          │
│      ├─ 验证从站地址 (0x16)                                       │
│      ├─ 识别功能码 (0x10)                                        │
│      └─ 调用 parseWriteResponse(data)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  13. parseWriteResponse 解析响应                                  │
│      ├─ 验证响应长度 (8字节)                                      │
│      ├─ 验证功能码 (0x10)                                        │
│      ├─ 检查异常响应 (功能码 | 0x80)                              │
│      └─ 返回解析结果                                              │
│         ├─ success: true/false                                   │
│         └─ error: 错误信息                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  14. 更新请求状态                                                │
│      ├─ 查找对应的写入请求 (isWrite == true)                      │
│      ├─ 如果成功:                                                 │
│      │   status = ModbusRequestStatus.completed                 │
│      │   completedAt = DateTime.now()                            │
│      └─ 如果失败:                                                 │
│          status = ModbusRequestStatus.failed                    │
│          errorMessage = 错误信息                                   │
│          completedAt = DateTime.now()                            │
│      └─ 从 _pendingRequests 中移除                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  15. 通过 Stream 发送状态更新                                     │
│      _requestStatusController.add(updatedRequest)               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  16. writeParameters 中的 Stream 监听器接收到状态更新            │
│      ├─ 检查 requestId 匹配                                      │
│      ├─ 如果 status == completed:                                │
│      │   completer.complete(true)                                │
│      ├─ 如果 status == failed 或 timeout:                        │
│      │   completer.complete(false)                               │
│      └─ 取消 Stream 订阅                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  17. writeParameters 返回结果                                    │
│      return await completer.future                              │
│      返回 true (成功) 或 false (失败)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  18. writeBatterySeriesCount 返回结果                            │
│      └─ 返回 true/false                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    用户界面层                                    │
│                    (quick_settings_page.dart)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  19. _writeBatterySeriesCount 接收结果                          │
│      ├─ 如果 success == true:                                    │
│      │   显示 "电池串数写入成功" (绿色)                           │
│      ├─ 如果 success == false:                                   │
│      │   显示 "电池串数写入失败" (红色)                           │
│      ├─ 启用设置按钮                                              │
│      └─ 3秒后自动清除状态提示                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  20. 流程结束                                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 关键时序图

```
用户界面          BatteryDataManager          ModbusProtocol          BMS设备
   │                      │                         │                   │
   │  点击设置按钮         │                         │                   │
   ├─────────────────────>│                         │                   │
   │                      │  writeParameters()      │                   │
   │                      ├────────────────────────>│                   │
   │                      │  buildWriteCommand()    │                   │
   │                      │<────────────────────────┤                   │
   │                      │                         │                   │
   │                      │  发送写入命令           │                   │
   │                      ├─────────────────────────────────────────────>│
   │                      │                         │                   │
   │                      │                         │                   │
   │  显示"正在写入..."    │                         │                   │
   │<─────────────────────┤                         │                   │
   │                      │                         │                   │
   │                      │                         │  处理写入请求     │
   │                      │                         │<──────────────────┤
   │                      │                         │                   │
   │                      │                         │  返回写入应答     │
   │                      │<────────────────────────────────────────────┤
   │                      │  handleResponse()     │                   │
   │                      │  parseWriteResponse()  │                   │
   │                      ├────────────────────────>│                   │
   │                      │<────────────────────────┤                   │
   │                      │                         │                   │
   │                      │  更新请求状态           │                   │
   │                      │  Stream通知             │                   │
   │                      │  返回结果               │                   │
   │  接收结果            │<────────────────────────┤                   │
   │<─────────────────────┤                         │                   │
   │                      │                         │                   │
   │  显示"写入成功/失败"  │                         │                   │
   │                      │                         │                   │
```

---

## 关键数据流

### 写入命令格式

| 字节位置 | 内容 | 说明 |
|---------|------|------|
| 0 | 0x16 | 从站地址 |
| 1 | 0x10 | 功能码（写入多个保持寄存器） |
| 2 | 0x02 | 起始地址高字节 (0x0200 >> 8) |
| 3 | 0x00 | 起始地址低字节 (0x0200 & 0xFF) |
| 4 | 0x00 | 寄存器数量高字节 (1 >> 8) |
| 5 | 0x01 | 寄存器数量低字节 (1 & 0xFF) |
| 6 | 0x02 | 字节数 (1个寄存器 × 2字节) |
| 7 | 0x00 | 数据高字节 (16 >> 8) |
| 8 | 0x10 | 数据低字节 (16 & 0xFF) |
| 9 | CRC_L | CRC16低字节 |
| 10 | CRC_H | CRC16高字节 |

**示例：写入电池串数16**
```
命令: 16 10 02 00 00 01 02 00 10 [CRC_L] [CRC_H]
```

### 响应格式

| 字节位置 | 内容 | 说明 |
|---------|------|------|
| 0 | 0x16 | 从站地址 |
| 1 | 0x10 | 功能码 |
| 2 | 0x02 | 起始地址高字节 |
| 3 | 0x00 | 起始地址低字节 |
| 4 | 0x00 | 寄存器数量高字节 |
| 5 | 0x01 | 寄存器数量低字节 |
| 6 | CRC_L | CRC16低字节 |
| 7 | CRC_H | CRC16高字节 |

**示例：写入成功响应**
```
响应: 16 10 00 02 00 01 [CRC_L] [CRC_H]
```

### 异常响应格式

当设备返回异常时，功能码会与0x80进行或运算：

| 字节位置 | 内容 | 说明 |
|---------|------|------|
| 0 | 0x16 | 从站地址 |
| 1 | 0x90 | 功能码 (0x10 \| 0x80) |
| 2 | 异常码 | 错误代码 |
| 3 | CRC_L | CRC16低字节 |
| 4 | CRC_H | CRC16高字节 |

---

## 超时处理

```
写入请求发送后
       │
       ├─ 正常响应 (5秒内) → 更新状态为 completed → 返回 true
       │
       ├─ 超时 (5秒后)     → 更新状态为 timeout  → 返回 false
       │
       └─ 异常响应         → 更新状态为 failed   → 返回 false
```

### 超时机制说明

1. **超时时间设置**：5秒
   - 在 `writeParameters` 方法中通过 `Future.delayed(const Duration(seconds: 5))` 设置

2. **超时处理逻辑**：
   ```dart
   Future.delayed(const Duration(seconds: 5), () {
     if (!completer.isCompleted) {
       subscription?.cancel();
       completer.complete(false);
     }
   });
   ```

3. **请求状态管理**：
   - 所有待处理的请求存储在 `_pendingRequests` Map 中
   - 通过 `_checkTimeouts()` 定期检查超时请求（每500ms）
   - 超时请求会尝试重试，最多重试3次
   - 超过最大重试次数后标记为 timeout 状态

4. **Stream订阅清理**：
   - 收到响应或超时后立即取消 Stream 订阅
   - 防止内存泄漏和重复处理

---

## 相关文件说明

| 文件路径 | 说明 |
|---------|------|
| `lib/pages/quick_settings_page.dart` | 快速设置页面，提供用户界面和交互逻辑 |
| `lib/managers/battery_data_manager.dart` | 电池数据管理器，处理数据读写和请求管理 |
| `lib/bluetooth/modbus_protocol.dart` | Modbus协议实现，构建和解析Modbus命令 |
| `lib/bluetooth/ble_controller.dart` | BLE通信控制器，处理蓝牙数据收发 |
| `lib/models/modbus_request.dart` | Modbus请求模型，定义请求结构和状态 |

---

## 关键方法说明

### BatteryDataManager

| 方法名 | 说明 | 参数 | 返回值 |
|-------|------|------|--------|
| `writeBatterySeriesCount` | 写入电池串数到0x200寄存器 | `count` - 电池串数 | `Future<bool>` |
| `writeParameters` | 通用参数写入方法 | `startAddress` - 起始地址, `values` - 值列表 | `Future<bool>` |
| `_sendRequest` | 发送Modbus请求 | `request` - Modbus请求对象 | `Future<bool>` |
| `handleResponse` | 处理设备响应 | `data` - 响应数据 | `void` |

### ModbusProtocol

| 方法名 | 说明 | 参数 | 返回值 |
|-------|------|------|--------|
| `buildWriteCommand` | 构建写入命令 | `slaveId`, `startAddress`, `values` | `Uint8List` |
| `parseWriteResponse` | 解析写入响应 | `data` - 响应数据 | `Map<String, dynamic>` |
| `calculateCRC16` | 计算CRC16校验码 | `data` - 数据 | `int` |

---

## 状态说明

### ModbusRequestStatus

| 状态 | 说明 |
|------|------|
| `pending` | 请求待发送 |
| `sent` | 请求已发送，等待响应 |
| `completed` | 请求完成（成功） |
| `failed` | 请求失败 |
| `timeout` | 请求超时 |

---

## 注意事项

1. **设备连接检查**：在发送写入请求前必须检查设备是否已连接
2. **输入验证**：必须验证用户输入的有效性（非空、有效数字、正数）
3. **状态管理**：正确管理请求状态，避免重复处理
4. **超时处理**：设置合理的超时时间，避免长时间等待
5. **错误处理**：捕获所有可能的异常，给用户明确的反馈
6. **UI反馈**：及时更新UI状态，提供清晰的用户反馈
7. **资源清理**：及时取消Stream订阅，避免内存泄漏

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-12-29 | 初始版本，完成电池串数写入流程文档 |
