## Fix Plan for OTA Upgrade Issues

### Issue 1: Image Data Transmission Method

**Current Status**: Flutter uses fixed maxChunkSize = 512 with manual loop + wait for ACK, while Java uses PRN = 2048 with auto-split and no manual ACK waiting.

**Fix Plan**:

1. Add PRN mechanism to `_sendImageData` function
2. Make chunk size configurable based on PRN value
3. Set default PRN to 2048 to match Java implementation
4. Keep the wait-for-ACK mechanism as it's required for reliability

### Issue 2: Missing Single Bank Upgrade Handling

**Current Status**: For ota\_selection == 3/4, Flutter lacks the complete reconnection flow that Java implements.

**Fix Plan**:

1. Add post-upgrade handling for ota\_selection == 3 || 4
2. Implement disconnection logic after upgrade completion
3. Add device reboot waiting mechanism
4. Implement MAC address increment logic (MAC+1)
5. Add reconnection to new MAC address
6. Implement second upgrade cycle for single Bank upgrade

### Implementation Details

#### 1. Modify `_sendImageData` Function

```dart
// Add PRN parameter with default value 2048
Future<void> _sendImageData({int prn = 2048}) async {
  // Use PRN as max chunk size
  const int maxChunkSize = prn;
  // ... existing logic ...
}
```

#### 2. Add Single Bank Upgrade Handling in `startUpgrade`

```dart
// After normal upgrade completion
if (_otaSelection == 3 || _otaSelection == 4) {
  // Step 1: Disconnect and wait for reboot
  await _handleSingleBankUpgrade();
}
```

#### 3. Implement `_handleSingleBankUpgrade` Function

```dart
Future<void> _handleSingleBankUpgrade() async {
  // Disconnect current device
  await _bleController.disconnect();
  
  // Wait for device reboot (3 seconds)
  await Future.delayed(const Duration(seconds: 3));
  
  // Increment MAC address
  String newMacAddress = _incrementMacAddress(_bleController.connectedDevice!.id);
  
  // Reconnect to new MAC address
  await _bleController.reconnectToImageUpdate(newMacAddress);
  
  // Perform second upgrade cycle
  await _sendImageData();
}
```

#### 4. Add Helper Functions

* `_incrementMacAddress()`: Increments the last byte of MAC address

* `reconnectToImageUpdate()` in BleController: Handles reconnection to new device

### Files to Modify

1. `lib/bluetooth/ota_upgrader.dart` - Main OTA logic
2. `lib/bluetooth/ble_controller.dart` - Add reconnection functionality

### Expected Behavior After Fix

* Image data transmission uses PRN = 2048

* Single Bank upgrade (ota\_selection 3/4) completes full cycle:

  * Upgrade → Disconnect → Reboot → Reconnect (MAC+1) → Upgrade again

* Matches Java implementation behavior exactly

