# 固件获取方式修改计划

## 需求分析
将固件升级的获取方式从本地文件选择改为从服务器获取，需要实现：
1. 检查服务器最新固件版本
2. 下载服务器固件文件
3. 替换原有的本地文件选择功能

## 修改内容

### 1. 添加依赖
- 添加 `http` 库用于HTTP请求（兼容Dart SDK 2.19.6的版本）

### 2. 修改 `firmware_update_page.dart`

#### 2.1 添加状态变量
- `bool _hasUpdate`：标记是否有新版本
- `String _latestVersion`：最新固件版本
- `String _firmwareDescription`：固件描述
- `String? _downloadUrl`：固件下载URL
- `String? _firmwareFilename`：固件文件名

#### 2.2 修改UI组件
- 将"选择固件文件"按钮替换为"检查更新"按钮
- 添加"下载固件"按钮（在检查到更新后显示）
- 显示固件版本比较信息
- 显示固件描述

#### 2.3 添加方法
- `_checkForUpdates()`：检查服务器是否有新版本固件
- `_downloadFirmware()`：下载服务器固件文件
- 保留原有 `_formatFileSize()` 方法用于显示下载进度

#### 2.4 修改升级流程
- 检查更新 → 下载固件 → 开始升级

### 3. 实现逻辑

#### 3.1 检查更新流程
1. 点击"检查更新"按钮
2. 发送HTTP GET请求到 `/ota/latest`
3. 比较返回的版本与当前版本
4. 如果有新版本，更新UI显示更新信息
5. 显示"下载固件"按钮

#### 3.2 下载固件流程
1. 点击"下载固件"按钮
2. 发送HTTP GET请求到 `download_url`
3. 显示下载进度
4. 下载完成后，调用 `_otaUpgrader.selectFirmwareFile()`
5. 更新UI显示已下载的固件信息

### 4. 错误处理
- 网络请求失败处理
- 版本比较异常处理
- 下载中断处理

## 修改步骤

1. 修改 `pubspec.yaml` 添加HTTP依赖
2. 更新 `firmware_update_page.dart` 的导入语句
3. 添加新的状态变量
4. 修改UI组件
5. 实现 `_checkForUpdates()` 方法
6. 实现 `_downloadFirmware()` 方法
7. 更新升级控制逻辑
8. 测试完整流程

## 预期效果

- 用户打开固件升级页面
- 点击"检查更新"按钮
- 显示服务器最新固件信息
- 点击"下载固件"按钮
- 显示下载进度
- 下载完成后，可以点击"开始升级"按钮
- 升级流程与原有保持一致

## 技术要点

- 使用 `http` 库进行HTTP请求
- 实现流式下载以显示进度
- 版本比较逻辑
- 异步状态管理
- 错误处理和用户反馈