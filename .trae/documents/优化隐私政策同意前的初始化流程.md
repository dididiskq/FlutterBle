# 支持第二种蓝牙板的实现计划

## 需求分析
1. **第一种蓝牙板**：一个一个读取寄存器
2. **第二种蓝牙板**：通过三条指令读取所有数据，三个表格对应的起始地址分别为 0x0000, 0x200, 0x400
3. 需要区分两种蓝牙板，后续会通过固件版本号区分，但现在先实现基本功能
4. 不能破坏现有逻辑，第二种蓝牙板还在开发中，只进行添加

## 实现步骤

### 1. 在 BatteryDataManager 类中添加标志位
- 添加 `_isNewBluetoothBoard` 布尔值，默认为 false
- 用于标识当前连接的蓝牙板类型

### 2. 修改 readAllData() 方法
- 添加分支判断，根据 `_isNewBluetoothBoard` 选择不同的数据读取方式
- 如果是第二种蓝牙板，发送三个读取请求（0x0000, 0x200, 0x400）
- 否则使用现有逻辑

### 3. 添加新的 Modbus 请求类型
- 在 `modbus_request.dart` 中添加新的请求类型，用于读取三个表格数据
- 例如：`readTable1Data`, `readTable2Data`, `readTable3Data`

### 4. 实现三个表格数据的读取方法
- 添加 `readTable1Data()`, `readTable2Data()`, `readTable3Data()` 方法
- 每个方法发送对应的 Modbus 读取请求

### 5. 实现响应数据解析方法
- 添加 `_processTable1Response()`, `_processTable2Response()`, `_processTable3Response()` 方法
- 根据表格结构解析响应数据，更新 `_currentData`

### 6. 更新 _processReadResponseByRequestType 方法
- 添加新的 case 分支，处理三个表格数据的响应

### 7. 确保现有逻辑不受影响
- 所有新添加的代码都应该是条件执行的，不影响现有功能
- 保留原有数据读取方法，确保第一种蓝牙板仍然可以正常工作

## 具体实现细节

### 读取指令示例
- 表格1：`16 03 00 00 00 3F 0B BE`（起始地址 0x0000，读取 0x3F 个寄存器）
- 表格2：`16 03 02 00 00 XX XX XX`（起始地址 0x200，读取 XX 个寄存器）
- 表格3：`16 03 04 00 00 XX XX XX`（起始地址 0x400，读取 XX 个寄存器）

### 数据解析示例
- 表格1包含电池温度、总电压、总电流、剩余容量等基本信息
- 表格2包含保护参数、充放电参数等
- 表格3包含历史数据、统计信息等
- 需要根据 `analyze_output.txt` 中的表格结构进行解析

## 测试和验证
- 确保现有功能仍然正常工作
- 确保新添加的功能可以正确读取和解析数据
- 测试数据更新是否及时、准确

## 后续扩展
- 后续可以通过读取固件版本号自动切换蓝牙板类型
- 可以添加更多的表格数据解析，支持更完整的功能

这个实现计划确保了对第二种蓝牙板的支持，同时保留了现有逻辑，符合用户的需求。